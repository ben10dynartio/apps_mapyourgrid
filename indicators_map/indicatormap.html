<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8">
    <title>MapYourGrid Heath Score</title>

<style>

:root {
  --mapyourgrid-primary: #036d7a;
  --left-panel-width:500px;
}

body {
  justify-content: center;
  align-items: center;
  color: #222;
  flex-direction: column;
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
}

iframe {
  position: fixed;
  background: #000;
  border: none;
  top: 0; right: 0;
  bottom: 0; left: 0;
  width: 100%;
  height: 100%;
}

.mapbox-improve-map {
    display:none;
}

#map {
position: absolute; top: 0; bottom: 0; width: 100%;
}


h1 {
  text-align: center;
}

h2 {
  position: relative;
  display: inline-block;
  font-size: 2.25rem;
  font-weight: 700;
  color: #2A6D3C;
  padding-bottom: 0.25rem;
  margin: 0;
  font-family: sans-serif;
}

h3 {
  background-color: var(--mapyourgrid-primary);;
    font-size: 1.3rem;
    color: #f4f4f4;
    padding: 2px 10px;
     text-align: center;
  }


.mini-website-icon {
  vertical-align: middle;
  margin-left:15px;
}

.container {
  display: flex;
  flex-wrap: wrap; /* Retour à la ligne auto */
  gap: 16px; /* Espace entre les blocs */
  justify-content: center;
}
.card {
  flex: 1 1 200px; /* Largeur min de 200px, ajustable */
  max-width: 125px;
  border: 1px solid #ccc;
  border-radius: 10px;
  padding: 10px;
  padding-bottom: 0px;
  text-align: center;
  background: #f9f9f9;
}
.card img {
  max-width: 100%;
  height: auto;
  margin-top: 8px;
}

.card b {
  display: block;
  font-size: 14px;
  margin-bottom: 8px;
  height: 45px;
  line-height:1.05;
}

/* Le volet latéral */
.sidepanel {
  position: fixed;
  right: -400px; /* caché par défaut */
  top: 0;
  width: var(--left-panel-width);
  height: 100%;
  background: #f4f4f4;
  box-shadow: -2px 0 5px rgba(0,0,0,0.3);
  transition: right 0.3s ease;
  padding: 20px;
  overflow-y: auto;
  display: none;
}

/* quand il est ouvert */
.sidepanel.open {
  right: 0;
  display: inline-block;
}

/* bouton de fermeture */
.close-btn {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 24px;
  cursor: pointer;
  color: #333;
}

.sidepanel img {
  max-width: 100%;
  border-radius: 10px;
  margin-bottom: 15px;
}


</style>

<link href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css" rel="stylesheet">

<script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>
<script src="https://unpkg.com/@turf/turf@^7/turf.min.js"></script>

</head>

<body>
<div id="map"></div>



<div id="mySidepanel" class="sidepanel">
    <span class='close-btn' onclick='closePanel()'>&times;</span>
    <div style='height:fit-content'>
      <div style='float: right;'>
        <img id="country-property-flag_image" src='http://x' style='margin-left: 15px;width:150px;'>
      </div>
      <div>
        <h2><span id="country-property-name">$country_name</span> (<span id="country-property-code_isoa2">$country_code</span>)</h2>
        <p><ul>
          <li><b>Population: </b><span id="country-property-population">$population</span></li>
          <li><b>Area: </b><span id="country-property-area_km2">$area_km2</span> km2</li>
          <li><b>GDP: </b><span id="country-property-gdp_bd">$gdp_bd</span> M$</li>
          <li><b>Number of power plants: </b><span id="country-property-power_plant_count">$power_plant_count</span></li>
          <li><b>Power plant capacity: </b><span id="country-property-power_plant_output_mw">$power_plant_output_mw</span> MW</li>
          <li><b>Power line length: </b><span id="country-property-power_line_total_length">$power_line_total_length</span> km</li>
          <li><b>Number of substations: </b><span id="country-property-stats_nb_substations">$stats_nb_substations</span></li>
          <li><b>Number of international connections: </b><span id="country-property-stats_nb_international_connections">$stats_nb_international_connections</span></li>
          <li><b>Line voltages: </b><span id="country-property-line_voltage">$line_voltage</span></li>
        </ul></p>
      </div>
    </div>

    <div id="internalSidePanel">
    <!-- AUTO GENERATED -->
    </div>

<br>

    <h3>Quality Score</h3>
    <div style='text-align: center;width:100%;'>
      <canvas id='ring_quality_score' width='250' height='120'></canvas>
    </div>
    <div class='container' id='quality_score_div'></div><br>
    <div style="text-align:center"><a href="indicatorsmethodo.html" target="_blank">See indicator computing methodology</a></div>

    <div id="voltage_section">
    <h3 id="voltage_headsection">Comparison of circuit lengths with official data</h3>
    <div id="voltage_comparaison_div" class="container" style='text-align: center;width:100%;'></div>
    <div style="text-align:center;margin-top:10px;"><a id="voltage_source_link" href="xxx" target="_blank">See official sources on OSM Wiki</a></div>
    </div>

    <h3>Estimated spatial coverage of substations</h3>
    <div style='text-align: center;width:100%;'>
      <canvas id='ring_coverage_score' width='250' height='120'></canvas>
    </div>



    <br><br><br><br>

</div>

<script>

const health_indicators = ['health_power_line_connectivity',
 'health_grid_connectivity_without_circuit',
 'health_grid_connectivity_with_circuit',
 'health_line_voltage_completeness',
 'health_line_cables_completness',
 'health_substation_voltage_completness',
 'health_connected_power_tower',
 'health_complete_power_line',
 'health_consistent_line_voltage_connection',
 'health_consistent_linesub_voltage_connection'];

 const indicator_title = {'health_power_line_connectivity':'Line connectivity',
 'health_grid_connectivity_without_circuit':'Grid connectivity (without circuit)',
 'health_grid_connectivity_with_circuit':'Grid connectivity (with circuit)',
 'health_line_voltage_completeness':'"Voltage"-tag completeness on lines and cables',
 'health_line_cables_completness':'"Cables"-tag completeness on lines and cables',
 'health_substation_voltage_completness':'"Voltage"-tag completeness on substations',
 'health_connected_power_tower':'Connected power tower',
 'health_complete_power_line':'Completed power lines',
 'health_consistent_line_voltage_connection':'Line-to-line voltage consistency',
 'health_consistent_linesub_voltage_connection':'Line-to-Substation voltage consistency'};

	mapboxgl.accessToken = 'pk.eyJ1IjoiZHluYXJ0aW8iLCJhIjoiY2wzcGtvbTBzMHcyMzNjbG5yemh4bHBtbSJ9.GmngJ7VptXnA87TO7steMA';
    const map = new mapboxgl.Map({
        container: 'map',
        // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
        style: 'mapbox://styles/dynartio/cmfit5dvi004u01qyhx04aif3',
        attributionControl: false,
        //center: [-96, 37.8],
        //zoom: 3
    });

  map.on('load', () => {
    map.addSource('worldmap-indicators', {
            'type': 'vector',
            'url': 'mapbox://dynartio.a216kfut'
        });

	map.addLayer({
		id: 'highlight-country',
		'slot': 'top',
		type: 'line',
		source: 'worldmap-indicators',
		'source-layer': 'worldmap_indicators-bbcgmb',
		paint: {
		  'line-color': '#da623d',
		  'line-width': 4,
		  'line-opacity': [
			'case',
			['boolean', ['feature-state', 'hover'], false],
			0.9,
			0,
		  ],
		},

	});
});

    map.addControl(new mapboxgl.AttributionControl({customAttribution: "MapYourGrid | Dynartio"}));

    //map.addControl(new mapboxgl.FullscreenControl({container: document.querySelector('body')}));

// ----------- Popup builder
map.on('click', (event) => {
  // If the user clicked on one of your markers, get its information.
  const features = map.queryRenderedFeatures(event.point, {
    layers: ["worldmap-indicators"] // replace with your layer(s) name
  });

  if (!features.length) {
    return;
  }
  const feature = features[0];

  build_popup_detail(feature, event.lngLat);

});

let current_select = false;

const ctmap = document.getElementById("map");
const panel = document.getElementById("mySidepanel");
const subpanel = document.getElementById("internalSidePanel");
const voltage_headsection = document.getElementById("voltage_headsection");
const voltage_comparaison_div = document.getElementById('voltage_comparaison_div');

const data_voltage_length_official = {
  "CO":{66:221, 110:3863, 115:8515, 220:2598, 230:11000, 500:7488},
  "NP":{66:515, 132:3968, 220:1105, 400:384},
}

const data_voltage_length_osm = {
  "CO":{66: 25.9, 110: 2424.11, 115: 4858.52, 138: 15.45, 220: 2487.97, 230: 11666.35, 500: 3885.42},
  "NP":{66: 216.85, 132: 2670.33, 220: 890.27, 400: 598.52},

}

function closePanel() {
    panel.classList.remove("open");
    //ctmap.style.left = 0;
}

function build_popup_detail(feature, ll) {
    let key="";

    const country_property_list = ["name", "code_isoa2", "population", "area_km2", "gdp_bd", "power_plant_count", "power_plant_output_mw", "power_line_total_length", "stats_nb_substations", "stats_nb_international_connections", "line_voltage"];
    for (const prop of country_property_list) {

      const myspan = document.getElementById("country-property-" + prop);
      myspan.innerHTML = feature.properties[prop];
    }

    key = "flag_image";
    const myelement = document.getElementById("country-property-" + key);
    myelement.src = "http://commons.wikimedia.org/wiki/Special:FilePath/" + feature.properties[key];

    let htmlcontent = "";
    htmlcontent += "<p align='center'>";
    htmlcontent += "<a href='https://wiki.openstreetmap.org/wiki/Power_networks/" + feature.properties.name.replace(/ /g, "_")  + "' target='_blank'><img src='https://wiki.openstreetmap.org/osm_logo_wiki.png' width='50' class='mini-website-icon'></a>";
    htmlcontent += "<a href='https://www.wikidata.org/wiki/" + feature.properties.wikidata_id + "' target='_blank'><img src='https://upload.wikimedia.org/wikipedia/commons/f/ff/Wikidata-logo.svg' class='mini-website-icon' width='60'></a>";
    htmlcontent += "<a href='https://openinframap.org/stats/area/" + feature.properties.name + "' target='_blank'><img src='logo_openinframap.png' width='50' class='mini-website-icon'></a>";
    htmlcontent += "<a href='https://www.openstreetmap.org/relation/" + feature.properties.osm_rel_id + "' target='_blank'><img src='https://upload.wikimedia.org/wikipedia/commons/thumb/b/b0/Openstreetmap_logo.svg/80px-Openstreetmap_logo.svg.png' width='50' class='mini-website-icon'></a>";
    htmlcontent += "</p>";



  panel.classList.add("open");
  subpanel.innerHTML = htmlcontent;
	  build_container();
    show_indicator(feature.properties);

      // VOLTAGE DIV, only for country with official data
    voltage_section.style.display="none";
    voltage_comparaison_div.innerHTML = "";
    if (feature.properties["code_isoa2"] in data_voltage_length_official) {
      build_voltage_div(feature.properties["code_isoa2"], feature.properties["name"]);
    }


  // ctmap.style.left = "calc(-1*var(--left-panel-width)/2)";

  /* if (current_select) {
	// Unhover the current feature
     console.log(feature);
		map.setFeatureState(
			{ sourceLayerId: 'highlight-country', source: 'worldmap-indicators', 'sourceLayer': 'worldmap_indicators-bbcgmb', id: current_select.id },
			{ hover: false }
		);
	}
	map.setFeatureState(
		{ sourceLayerId: 'highlight-country', source: 'worldmap-indicators', 'sourceLayer': 'worldmap_indicators-bbcgmb', id: feature.id },
		{ hover: true }
	);
	current_select = feature;*/

}


function build_container() {
  const container = document.getElementById('quality_score_div');
  container.innerHTML = "";

  // Exemple : utiliser une image factice (placeholder)
  for (const indicator of health_indicators) {
    const div = document.createElement('div');
    div.className = 'card';

    // Titre
    const title = document.createElement('b');
    title.innerHTML = indicator_title[indicator];

    // Image (ici un placeholder, tu peux remplacer l'URL)
    const canvas = document.createElement('canvas');
    canvas.id = "ring_" + indicator;
    canvas.width = 75;
    canvas.height = 75;

    div.appendChild(title);
    div.appendChild(canvas);
    container.appendChild(div);
  };
}


function build_voltage_div(country_code, country_name) {
  voltage_section.style.display="block";

  for (const [ myvoltage, mylength ] of Object.entries(data_voltage_length_official[country_code])) {
    // do something with `key` and `value`

    const div = document.createElement('div');
    div.className = 'card';

    // Titre
    const title = document.createElement('b');
    title.innerHTML = myvoltage.toString() + " kV<br><i>(" + mylength.toString() + " km)</i>";

    // Image (ici un placeholder, tu peux remplacer l'URL)
    const canvas = document.createElement('canvas');
    canvas.id = "ring_" + myvoltage;
    canvas.width = 75;
    canvas.height = 75;

    div.appendChild(title);
    div.appendChild(canvas);
    voltage_comparaison_div.appendChild(div);

    value_pct = (100*data_voltage_length_osm[country_code][myvoltage] / mylength).toFixed(1);
    drawRing("ring_" + myvoltage, value_pct, "XXS");
  }


  const awikipage = document.getElementById("voltage_source_link");
  awikipage.href = "https://wiki.openstreetmap.org/wiki/Power_networks/" + country_name.replace(/ /g, "_") + "#Network_statistics";

}

</script>


<script>

    function percentToColor(p) {
      // Interpolation entre rouge (0%) → jaune (seuil%) → vert (100%)
      let r, g, b = 0;
      let seuil=65;
      if (p < seuil) {
        // rouge -> jaune (rouge=255, vert=0→255)
        r = 255;
        g = Math.round(255 * (p / seuil));
      } else {
        // jaune -> vert (rouge=255→0, vert=255)
        g = 255;
        r = Math.round(255 * (1 - (p - seuil) / seuil));
      }
      return `rgb(${r},${g},${b})`;
    }

    function drawRing(ringname, percent, size) {
    const canvas = document.getElementById(ringname);
    const ctx = canvas.getContext("2d");
    let element_size = {};
    if (size=="XXS") {
      element_size = {
        radius:30,
        lineWidth:10,
        font:"bold 11px sans-serif",
      };
    } else if (size=="XS") {
      element_size = {
        radius:45,
        lineWidth:14,
        font:"bold 14px sans-serif",
      };
    } else if (size=="S") {
      element_size = {
        radius:60,
        lineWidth:20,
        font:"bold 24px sans-serif",
      };
    } else {
      element_size = {
        radius:90,
        lineWidth:30,
        font:"bold 24px sans-serif",
      };
    }
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const startAngle = -Math.PI / 2; // commence en haut
      const endAngle = startAngle + (percent / 100) * 2 * Math.PI;

      // Anneau de fond
      ctx.beginPath();
      ctx.arc(canvas.width / 2, canvas.height / 2, element_size["radius"], 0, 2 * Math.PI);
      ctx.lineWidth = element_size["lineWidth"]-1;
      ctx.strokeStyle = "#444";
      ctx.stroke();

      // Progression
      ctx.beginPath();
      ctx.arc(canvas.width / 2, canvas.height / 2, element_size["radius"], startAngle, endAngle);
      ctx.strokeStyle = percentToColor(percent);
      ctx.lineWidth = element_size["lineWidth"];
      ctx.lineCap = "butt";
      ctx.stroke();

      // Texte au centre
      ctx.fillStyle = "222";
      ctx.font = element_size["font"];
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(`${percent}%`, canvas.width / 2, canvas.height / 2);
    }

function show_indicator(feature_properties) {

    for (const indicator of health_indicators) {
      drawRing("ring_" + indicator, feature_properties[indicator].toFixed(1), "XXS");
    }
drawRing("ring_quality_score", (feature_properties["quality_score"]*100).toFixed(1), "XS");
drawRing("ring_coverage_score", feature_properties["coverage_population"], "XS");
//drawRing("ring_coverage_score", 75.3, "XS");
}


  </script>


  </body>
</html>
